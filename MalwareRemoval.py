# Autor: Dakshitha Perera
# Data : 19/01/2021
# Title : program to remove Malware Sample Two.
from winreg import *
import tempfile
import psutil
import sqlite3
import winreg
import os
import re


def ProcessMonitoring():
	tempDir = tempfile.gettempdir()


	malProcess = "svchost.exe"
	for proc in psutil.pids():
		p = psutil.Process(proc)
		if(p.name()) == malProcess:
			try:
				Procfiles = p.open_files()
			except:
				# print("couldn't find the malware process on the running processes")
				continue
			for root, dirs, files in os.walk(tempDir):
			    for file in files:
			        searchFiles = re.compile(r'.*[.]txt')
			        matches = re.findall(searchFiles, file)
			        if matches:
			            if(matches[0][-11:] == "(H).txt.txt"):
			            	malwareRealName = matches[0]
			            	print("The malware name is {}".format(malwareRealName))
			            	try:
			            		p.kill()
			            		print("Running Malware Processes PID {}was killed".format(proc))
			            		os.remove(os.path.join(tempDir, malwareRealName))
			            	except:
			                	print("Couldn't kill the Process!!!")

def ChromeHistryDelete():
	username = os.getlogin()

	db = sqlite3.connect('c:\\Users\\{}\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\History'.format(username))
	c = db.cursor()

	URLPattern = re.compile(r"https?://([^/]+)/")
	domains = {}

	result = True
	id = 0
	while result:
	    result = False
	    ids = []

	    for row in c.execute('SELECT id, url, title FROM urls WHERE id > ? LIMIT 1000', (id,)):
	        result = True
	        match = URLPattern.search(row[1])
	        id = row[0]

	        if match:
	            domain = match.group(1)
	            domains[domain] = domains.get(domain, 0) + 1
	            # clean if this is true
	            if "discriminate.blockey.ru" in domain:
	                ids.append((id,))

	    c.executemany('DELETE FROM urls WHERE id=?', ids)
	    db.commit()

	db.close()

def ClearChromeCookies():
	username = os.getlogin()

	db = sqlite3.connect('c:\\Users\\{}\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Cookies'.format(username))
	c = db.cursor()

	result = True
	while result:
		result = False
		ids = []

		for row in c.execute('SELECT creation_utc, host_key, name FROM Cookies'):
			id = row[0]
			if row[1] == '.discriminate.blockey.ru:
				ids.append((id, ))
		
		c.executemany('DELETE FROM Cookies WHERE creation_utc=?', ids)
		db.commit()

	db.close()

def ClearChromeCache():
	username = os.getlogin()

	db = ('C:\\Users\\{}\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Cache'.format(username))

	for root, dirs, files in os.walk(db):
	    for filename in files:
	    	pattern = re.compile(r'^f.')
	    	matches = pattern.finditer(filename)
	    	for match in matches:
	    		os.remove('C:\\Users\\{}\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Cache\\{}'.format(username, filename))
	    		print("Deleting {}".format(filename))

def DeleteRegistry():
	keyVal = r"SOFTWARE\Wow6432Node\Microsoft\Tracing"

	aKey = OpenKey(HKEY_LOCAL_MACHINE, keyVal, 0, KEY_ALL_ACCESS)
	try:
	    i = 0
	    while True:
	        asubkey = winreg.EnumKey(aKey, i)
	        # print(asubkey)
	        searchReg = re.compile(r'^(?!IpHlpSvc|iexplore|setup|Squirre).*')
	        matches = re.findall(searchReg, asubkey)
	        if matches:
	        	GuessingMalwareRealName = matches[0].split("_")[0]
	        	print("The malware name is {}".format(GuessingMalwareRealName))
	        	userInput = input("Would you take it and delete the regkey(y/n) : ")
	        	if userInput == "y":
	        		print("regkey will be delete shortly!! ")
	        		RegValue = str(asubkey[0])
	        		RegData = str(asubkey[1])
	        		winreg.DeleteValue(hKey, RegValue)
	        		break

	        	else:
	        		print("unable to delete Malware Registry!!!")
	        i += 1
	except:
		pass

ChromeHistryDelete()
ClearChromeCache()
ClearChromeCache()
DeleteRegistry()
ProcessMonitoring()
